<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiMeios | Miguel Gurgel</title>
  <link rel="stylesheet" href="/_MultiMeios/Frontend/CSS/dashboard.css" />
  <link rel="shortcut icon" href="https://img.icons8.com/color/48/book.png" type="image/x-icon">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body>
  <button class="sidebar-menu-button"><span class="material-symbols-rounded">menu</span></button>
  <aside class="sidebar">
    <header class="sidebar-header">
      <a href="#" class="header-logo"><img src="/_MultiMeios/Frontend/Logo.png" alt="Logo" /></a>
      <button class="sidebar-toggler"><span class="material-symbols-rounded">chevron_left</span></button>
    </header>
    <nav class="sidebar-nav">
      <ul class="nav-list primary-nav">
        <li class="nav-item"><a href="#" class="nav-link" data-target="painel"><span
              class="material-symbols-rounded">dashboard</span><span class="nav-label">Painel</span></a></li>
        <li class="nav-item dropdown-container">
          <a href="#" class="nav-link dropdown-toggle"><span class="material-symbols-rounded">calendar_today</span><span
              class="nav-label">Servi√ßos</span><span
              class="dropdown-icon material-symbols-rounded">keyboard_arrow_down</span></a>
          <ul class="dropdown-menu">
            <li class="nav-item"><a href="#" class="nav-link dropdown-link" data-target="cad-livro">Cadastrar Livros</a>
            </li>
            <li class="nav-item"><a href="#" class="nav-link dropdown-link" data-target="alugar-livro">Alugar Livros</a>
            </li>
            <li class="nav-item"><a href="#" class="nav-link dropdown-link" data-target="res-livro">Reservar Livros</a>
            </li>
          </ul>
        </li>
        <li class="nav-item"><a href="#" class="nav-link" data-target="notificacoes"><span
              class="material-symbols-rounded">notifications</span><span class="nav-label">Notifica√ß√µes</span></a></li>
        <li class="nav-item"><a href="#" class="nav-link" data-target="configuracoes"><span
              class="material-symbols-rounded">settings</span><span class="nav-label">Configura√ß√µes</span></a></li>
      </ul>
      <ul class="nav-list secondary-nav">
        <li class="nav-item"><a href="/_MultiMeios/Frontend/index.html" class="nav-link"><span
              class="material-symbols-rounded">logout</span><span class="nav-label">Sair</span></a></li>
      </ul>
    </nav>
  </aside>

  <main>
    <!-- PAINEL -->
    <section id="painel" class="active">
      <h2 id="tituloPainel">üìä Painel Principal</h2>
      <div class="card">Bem-vindo ao sistema MultiMeios!</div>

      <div class="cards-dashboard">
        <div class="card">
          <h3>Total de Livros</h3>
          <p id="totalLivrosDashboard">0</p>
        </div>
        <div class="card">
          <h3>Total de Reservas</h3>
          <p id="totalReservasDashboard">0</p>
        </div>
        <div class="card">
          <h3>Notifica√ß√µes</h3>
          <p id="totalNotificacoesDashboard">0</p>
        </div>
      </div>

      <div class="listagem">
        <h3>üîé Buscar livros</h3>
        <input id="buscarLivroInput" placeholder="Digite t√≠tulo, autor ou categoria" oninput="buscarLivroInput()" />
        <h3>üìò Livros</h3>
        <ul id="listaLivrosPainel"></ul>
        <button id="verMaisBtn" class="verMais" onclick="mostrarMaisLivros()">Ver mais</button>
      </div>

      <div class="listagem">
        <h3>üìÖ Reservas</h3>
        <ul id="listaReservasPainel"></ul>
      </div>
    </section>

    <!-- CADASTRAR LIVRO -->
    <section id="cad-livro">
      <h2>üìö Cadastrar Livro</h2>
      <form id="formCadastro" onsubmit="return false;">
        <input type="text" id="titulo" placeholder="T√≠tulo do Livro" required />
        <input type="text" id="autor" placeholder="Autor" required />
        <input type="text" id="ano" placeholder="Ano (opcional)" />
        <input type="text" id="isbn" placeholder="ISBN (opcional)" />
        <select id="categoria" required>
          <option value="">Selecione a Categoria</option>
          <option>Romance</option>
          <option>Fic√ß√£o</option>
          <option>Terror</option>
          <option>Fantasia</option>
          <option>Aventura</option>
          <option>Suspense/Thriller</option>
          <option>Fic√ß√£o Cient√≠fica</option>
          <option>Educa√ß√£o</option>
          <option>Hist√≥ria</option>
          <option>Biografia</option>
          <option>Autoajuda</option>
          <option>Ci√™ncias</option>
          <option>Filosofia</option>
          <option>Tecnologia / Inform√°tica</option>
          <option>Poesia</option>
          <option>Infantil / Juvenil</option>
          <option>Quadrinhos / Mang√°</option>
          <option>Artes / Design</option>
          <option>Esportes</option>
        </select>

        <!-- bot√£o com type="button" pra n√£o submeter o form e chamar a fun√ß√£o JS -->
        <button type="button" onclick="adicionarLivro()">Salvar Livro</button>
      </form>

      <div class="listagem">
        <h3>üìò Livros Cadastrados</h3>
        <ul id="listaLivrosCadastro"></ul>
      </div>
    </section>

    <!-- ALUGAR LIVRO -->
    <section id="alugar-livro">
      <h2>üìÖ Alugar Livro</h2>

      <form id="formAlugar">
        <input type="text" id="nomeAlunoAlugar" placeholder="Nome do Aluno" required>

        <input type="text" id="tituloReservaAlugar" placeholder="T√≠tulo do Livro" required>

        <label for="dataAluguel">Data do Aluguel:</label>
        <input type="date" id="dataReservaAlugar" required>

        <label for="dataDevolucao">Data da Devolu√ß√£o:</label>
        <input type="date" id="dataDevolucaoAlugar" required>

        <button type="submit">Registrar Aluguel</button>
      </form>

      <div class="listagem">
        <h3>üìö Alugu√©is Registrados</h3>
        <ul id="listaAluguelSecao"></ul>
      </div>
    </section>

    <!-- RESERVAR LIVRO -->
    <section id="res-livro">
      <h2>üìÖ Reservar Livro</h2>
      <form id="formReservar">
        <input type="text" id="nomeAlunoRes" placeholder="Nome do Aluno" required />
        <input type="text" id="tituloReservaRes" placeholder="T√≠tulo do Livro" required />
        <input type="date" id="dataReservaRes" required />
        <button type="submit">Reservar</button>
      </form>

      <div class="listagem">
        <h3>üë• Reservas Feitas</h3>
        <ul id="listaReservasSecao"></ul>
      </div>
    </section>

    <!-- NOTIFICA√á√ïES -->
    <section id="notificacoes">
      <h2>üîî Notifica√ß√µes</h2>
      <div id="notificacoesContainer"></div>
    </section>

    <!-- CONFIGURA√á√ïES -->
    <section id="configuracoes">
      <h2>‚öôÔ∏è Configura√ß√µes</h2>
      <div class="card">
        <label>üèõÔ∏è Nome da Biblioteca</label>
        <input type="text" id="nomeBiblioteca" placeholder="Ex: MultiMeios Miguel Gurgel" />
        <label><input type="checkbox" id="modoEscuro" /> Ativar modo escuro</label>

        <div>
          <button id="exportar" type="button">üì§ Exportar Backup</button>
          <input type="file" id="importarArquivo" accept=".json" hidden />
          <button id="importar" type="button">üì• Importar Backup</button>
          <button id="limparTudo" type="button">üßπ Limpar todos os dados</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let livros = [];
    let reservas = [];
    let notificacoes = [];

    // ===== MENU & SIDEBAR =====
    const toggleDropdown = (dropdown, menu, isOpen) => {
      dropdown.classList.toggle("open", isOpen);
      menu.style.height = isOpen ? `${menu.scrollHeight}px` : 0;
    };

    const closeAllDropdowns = () =>
      document.querySelectorAll(".dropdown-container.open")
        .forEach(d => toggleDropdown(d, d.querySelector(".dropdown-menu"), false));

    document.querySelectorAll(".dropdown-toggle").forEach(btn => {
      btn.addEventListener("click", e => {
        e.preventDefault();
        const dropdown = btn.closest(".dropdown-container");
        const menu = dropdown.querySelector(".dropdown-menu");
        const isOpen = dropdown.classList.contains("open");

        closeAllDropdowns();
        toggleDropdown(dropdown, menu, !isOpen);
      });
    });

    document.querySelectorAll(".sidebar-toggler, .sidebar-menu-button")
      .forEach(btn => btn.addEventListener("click", () => {
        closeAllDropdowns();
        document.querySelector(".sidebar").classList.toggle("collapsed");
      }));

    if (window.innerWidth <= 1024)
      document.querySelector(".sidebar").classList.add("collapsed");

    // ===== TROCA DE TELAS =====
    const sections = document.querySelectorAll("main section");

    document.querySelectorAll("[data-target]").forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const target = link.dataset.target;

        sections.forEach(sec => sec.classList.remove("active"));
        document.getElementById(target).classList.add("active");

        atualizarListas();
      });
    });

    // ===== FUN√á√ïES CSV (Livros) =====
    async function carregarLivrosCSV() {
      try {
        const resp = await fetch("/_MultiMeios/Backend/livros.csv");
        const texto = await resp.text();

        livros = texto
          .split("\n")
          .slice(1)
          .map(l => l.split(","))
          .filter(c => c.length >= 6)
          .map(c => ({
            titulo: c[0],
            autor: c[1],
            ano: c[2],
            isbn: c[3],
            categoria: c[4],
            quantidade: c[5]
          }));

        atualizarListas();
      } catch (e) {
        console.error("Erro ao carregar CSV:", e);
      }
    }

    // ===== LISTAGENS =====
    let qtdVisivel = 5; // quantos livros aparecem por vez

    function listarLivrosFront() {
      const listaPainel = document.getElementById("listaLivrosPainel");
      const listaCadastro = document.getElementById("listaLivrosCadastro");
      const btnVerMais = document.getElementById("verMaisBtn");

      if (!livros.length) {
        listaCadastro.innerHTML = "<li>Nenhum livro cadastrado ainda.</li>";
        listaPainel.innerHTML = "<li>Nenhum livro cadastrado ainda.</li>";
        btnVerMais.style.display = "none";
        return;
      }

      // üî• S√≥ os vis√≠veis
      const visiveis = livros.slice(0, qtdVisivel);

      const htmlVisivel = visiveis
        .map(l => `<li><strong>${l.titulo}</strong> ‚Äî ${l.autor} (${l.categoria})</li>`)
        .join("");

      // Cadastro sempre mostra tudo
      const htmlCadastro = livros
        .map(l => `<li><strong>${l.titulo}</strong> ‚Äî ${l.autor} (${l.categoria})</li>`)
        .join("");

      listaCadastro.innerHTML = htmlCadastro;
      listaPainel.innerHTML = htmlVisivel;

      // Se ainda tem livro escondido ‚Üí mostra bot√£o
      if (qtdVisivel < livros.length) {
        btnVerMais.style.display = "block";
      } else {
        btnVerMais.style.display = "none";
      }
    }

    function mostrarMaisLivros() {
      qtdVisivel += 5; // adiciona +5 livros
      listarLivrosFront();
    }

    function listarReservasFront() {
      const html = reservas.length
        ? reservas.map((r, i) =>
          `<li>
          <span><strong>${r.livro}</strong> por ${r.aluno} em ${new Date(r.data).toLocaleDateString()}</span>
          <button class="delete-btn" onclick="removerReserva(${i})">Cancelar</button>
        </li>`
        ).join("")
        : "<li>Nenhuma reserva ainda.</li>";

      document.getElementById("listaReservasSecao").innerHTML = html;
      document.getElementById("listaReservasPainel").innerHTML = html;
    }

    function atualizarDashboard() {
      document.getElementById("totalLivrosDashboard").textContent = livros.length;
      document.getElementById("totalReservasDashboard").textContent = reservas.length;
      document.getElementById("totalNotificacoesDashboard").textContent = notificacoes.length;
    }

    function atualizarListas() {
      // resetar quantidade vis√≠vel ao atualizar
      qtdVisivel = 5;

      listarLivrosFront();
      listarReservasFront();
      atualizarDashboard();

      const container = document.getElementById("notificacoesContainer");
      container.innerHTML = notificacoes
        .map(msg => `<div class="notify">${msg}</div>`)
        .join("");
    }

    // ===== BACKEND (opcional) =====
    async function carregarLivros() {
      const res = await fetch("http://localhost:3000/livros");
      livros = await res.json();
      mostrarLivros(livros);
    }

    function mostrarLivros(lista) {
      const div = document.getElementById("lista-livros");
      div.innerHTML = "";

      lista.forEach(l => {
        div.innerHTML += `
        <div class="livro-item">
          <strong>${l.titulo}</strong><br>
          Autor: ${l.autor}<br>
          Ano: ${l.ano}
        </div>
        <hr>
        `;
      });
    }

    async function adicionarLivro() {
      const titulo = document.getElementById("titulo").value;
      const autor = document.getElementById("autor").value;
      const ano = document.getElementById("ano").value;

      const res = await fetch("http://localhost:3000/livros", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ titulo, autor, ano })
      });

      livros = await res.json();
      mostrarLivros(livros);
    }

    // ===== NOTIFICA√á√ïES =====
    function notificacao(msg) {
      notificacoes.unshift(msg);
      atualizarListas();
    }

    // ===== RESERVAR =====
    function reservarLivro(e) {
      e.preventDefault();

      const aluno = document.getElementById("nomeAlunoRes").value.trim();
      const livro = document.getElementById("tituloReservaRes").value.trim();
      const data = document.getElementById("dataReservaRes").value;

      if (!aluno || !livro || !data)
        return alert("Preencha todos os campos!");

      reservas.push({ aluno, livro, data });
      notificacao(`üìå ${aluno} reservou o livro "${livro}".`);

      e.target.reset();
      atualizarListas();
    }

    // ===== ALUGAR =====
    function alugarLivro(e) {
      e.preventDefault();

      const aluno = document.getElementById("nomeAlunoAlugar").value.trim();
      const livro = document.getElementById("tituloReservaAlugar").value.trim();
      const data = document.getElementById("dataReservaAlugar").value;

      if (!aluno || !livro || !data)
        return alert("Preencha todos os campos!");

      reservas.push({ aluno, livro, data });
      notificacao(`üìÖ ${aluno} alugou o livro "${livro}".`);

      e.target.reset();
      atualizarListas();
    }

    function removerReserva(i) {
      if (!confirm("Cancelar esta reserva?")) return;
      reservas.splice(i, 1);
      notificacao("‚ùå Reserva cancelada.");
      atualizarListas();
    }

    // ===== BUSCAR =====
    function buscarLivroInput() {
      const termo = document.getElementById("buscarLivroInput").value.trim().toLowerCase();
      const lista = document.getElementById("listaLivrosPainel");

      if (termo === "") {
        lista.innerHTML = "<li>Digite algo para buscar.</li>";
        return;
      }

      const encontrados = livros.filter(l =>
        l.titulo.toLowerCase().includes(termo) ||
        l.autor.toLowerCase().includes(termo) ||
        l.categoria.toLowerCase().includes(termo)
      );

      lista.innerHTML = encontrados.length
        ? encontrados.map(l => `<li>${l.titulo} ‚Äî ${l.autor}</li>`).join("")
        : "<li>‚ùå Nenhum livro encontrado.</li>";
    }

    // ===== FORMUL√ÅRIOS =====
    document.getElementById("formReservar").addEventListener("submit", reservarLivro);
    document.getElementById("formAlugar").addEventListener("submit", alugarLivro);

    // ===== DARK MODE =====
    const darkToggle = document.getElementById("modoEscuro");
    darkToggle.checked = localStorage.getItem("darkMode") === "true";

    if (darkToggle.checked) document.body.classList.add("dark");

    darkToggle.addEventListener("change", e => {
      document.body.classList.toggle("dark", e.target.checked);
      localStorage.setItem("darkMode", e.target.checked);
    });

    // ===== EXPORTAR =====
    document.getElementById("exportar").addEventListener("click", () => {
      const blob = new Blob(
        [JSON.stringify({ livros, reservas, notificacoes })],
        { type: "application/json" }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_multimeios.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // ===== IMPORTAR =====
    const importarArquivo = document.getElementById("importarArquivo");
    document.getElementById("importar").addEventListener("click", () => importarArquivo.click());

    importarArquivo.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const dados = JSON.parse(e.target.result);
          livros = dados.livros || [];
          reservas = dados.reservas || [];
          notificacoes = dados.notificacoes || [];

          atualizarListas();
          alert("Backup importado com sucesso!");
        } catch {
          alert("Erro ao importar backup!");
        }
      };

      reader.readAsText(file);
    });

    // ===== LIMPAR =====
    document.getElementById("limparTudo").addEventListener("click", () => {
      if (!confirm("Tem certeza que deseja limpar todos os dados?")) return;

      livros = [];
      reservas = [];
      notificacoes = [];

      atualizarListas();
      alert("Todos os dados foram limpos!");
    });

    // ===== INITIAL LOAD =====
    carregarLivrosCSV();  // s√≥ CSV inicial
  </script>
</body>

</html>